name: Train SR Models

on:
  workflow_dispatch:
    inputs:
      iterations:
        description: 'Number of SR iterations'
        default: '50'
        type: string
      category:
        description: 'Category to train (all, petal_geometry, bone_rigging, animation_params)'
        default: 'all'
        type: string

jobs:
  train:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # SR training can take time

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # PySR requires Julia
      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: '1.9'

      - name: Install PySR Julia dependencies
        run: |
          python -c "
          import pysr
          pysr.install()
          " || echo "PySR Julia setup may need manual intervention"

      - name: Check dataset exists
        run: |
          if [ ! -f "data/processed/petal_geometry.csv" ]; then
            echo "Dataset not found. Generating..."
            python scripts/generate_rose_dataset.py
          else
            echo "Dataset found."
          fi

      - name: Train SR models
        env:
          ITERATIONS: ${{ github.event.inputs.iterations }}
          CATEGORY: ${{ github.event.inputs.category }}
        run: |
          echo "Training SR models..."
          echo "Iterations: $ITERATIONS"
          echo "Category: $CATEGORY"

          # Modify script to use input parameters
          python scripts/train_sr_models.py

      - name: Generate Python code from formulas
        run: |
          echo "Generating Python code..."
          python scripts/codegen_formulas.py

      - name: Generate CLI samples from discovered formulas
        run: |
          echo "Generating CLI samples..."
          mkdir -p data/cli_samples

          # Generate samples for different rose configurations
          for size in 2.0 3.0 4.0; do
            for opening in 0.0 0.5 1.0; do
              echo "Generating: size=$size, opening=$opening"
              python scripts/generate_spline_cli.py \
                --size $size \
                --opening $opening \
                --output data/cli_samples/rose_${size}_${opening}.txt \
                --verbose \
                2>&1 | head -20
            done
          done

          echo ""
          echo "Generated CLI samples:"
          ls -la data/cli_samples/ || echo "No samples generated"

          # Show sample output
          if [ -f "data/cli_samples/rose_3.0_0.5.txt" ]; then
            echo ""
            echo "Sample CLI (rose_3.0_0.5.txt - first 30 lines):"
            head -30 data/cli_samples/rose_3.0_0.5.txt
          fi

      - name: Run tests
        run: |
          echo "Running tests on discovered formulas..."
          python -m pytest tests/ -v || echo "Some tests may fail initially"

      - name: Upload models as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sr-discovered-formulas
          path: |
            data/models/
            data/generated/
            data/cli_samples/
          retention-days: 90

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: Update SR-discovered formulas"
          title: "[AutoML] New SR-discovered formulas"
          body: |
            ## Automated Symbolic Regression Training

            This PR contains newly discovered formulas from the SR training pipeline.

            ### Changes:
            - Updated formulas in `data/models/`
            - Auto-generated Python code in `data/generated/`
            - CLI samples in `data/cli_samples/`

            ### Training Parameters:
            - Iterations: ${{ github.event.inputs.iterations }}
            - Category: ${{ github.event.inputs.category }}

            ### Review Checklist:
            - [ ] Check RÂ² scores in formula JSONs
            - [ ] Review generated Python code
            - [ ] Test CLI samples with Blender/rendering
            - [ ] Run integration tests

          branch: automated/sr-formulas-update
          delete-branch: true
