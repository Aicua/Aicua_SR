name: Test Pipeline

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - 'tests/**'
      - 'configs/**'
      - 'requirements.txt'
      - '.github/workflows/**'

# Cancel duplicate runs - only keep the latest
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ci.txt

      - name: Lint Python files
        run: |
          pip install flake8
          flake8 scripts/ --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: Generate test datasets (v3/v7)
        run: |
          python scripts/generate_petal_spline_v3.py
          python scripts/generate_bone_rigging_v7.py

      - name: Generate CoT dataset
        run: |
          python scripts/generate_cot_dataset.py

      - name: Train models (mock/quick)
        run: |
          python scripts/train_sr_models.py

      - name: Generate code
        run: |
          python scripts/codegen_formulas.py

      - name: Run unit tests
        run: |
          python -m pytest tests/ -v --tb=short

      - name: Test CLI generation (Spline)
        run: |
          python scripts/generate_spline_cli.py --size 2.0 --opening 0.8 --layers 2 --output /tmp/test_rose.cli

          echo "Generated Spline CLI preview:"
          head -50 /tmp/test_rose.cli

          # Validate spline commands exist
          if ! grep -q "spline" /tmp/test_rose.cli; then
            echo "Error: No spline commands found"
            exit 1
          fi

          if ! grep -q "wing_flap" /tmp/test_rose.cli; then
            echo "Error: No wing_flap commands found"
            exit 1
          fi

          lines=$(wc -l < /tmp/test_rose.cli)
          echo "Total lines: $lines"

          if [ $lines -lt 50 ]; then
            echo "Error: Spline CLI seems too short"
            exit 1
          fi

          echo "✓ Spline CLI generation test passed"

      - name: Test CoT CLI generation
        run: |
          python scripts/generate_cot_cli.py --size 2.0 --opening 0.8 --layers 1 --detail medium --output /tmp/test_cot.cli

          echo "Generated CoT CLI preview:"
          head -30 /tmp/test_cot.cli

          # Validate CoT reasoning comments
          if ! grep -q "CoT Decision" /tmp/test_cot.cli; then
            echo "Error: No CoT Decision comments found"
            exit 1
          fi

          if ! grep -q "spline" /tmp/test_cot.cli; then
            echo "Error: No spline commands found"
            exit 1
          fi

          echo "✓ CoT CLI generation test passed"

      - name: Test Flower CLI with MOVE+ROTATE
        run: |
          # Generate positioning dataset first
          python scripts/generate_petal_positioning_v1.py

          # Train SR models (mock)
          python scripts/train_sr_positioning_v1.py

          # Generate flower CLI with 3 petals
          python scripts/generate_flower_cli_v1.py --petals 3 --radius 5.0 --output /tmp/test_flower.cli

          echo "Generated Flower CLI preview:"
          head -50 /tmp/test_flower.cli

          # Validate MOVE commands
          if ! grep -q "^move" /tmp/test_flower.cli; then
            echo "Error: No move commands found"
            exit 1
          fi

          # Validate ROTATE commands
          if ! grep -q "^rotate" /tmp/test_flower.cli; then
            echo "Error: No rotate commands found"
            exit 1
          fi

          # Validate CoT Positioning Reasoning
          if ! grep -q "CoT Positioning Reasoning" /tmp/test_flower.cli; then
            echo "Error: No CoT Positioning Reasoning found"
            exit 1
          fi

          # Count move/rotate commands (should have 3 each for 3 petals)
          move_count=$(grep -c "^move" /tmp/test_flower.cli || true)
          rotate_count=$(grep -c "^rotate" /tmp/test_flower.cli || true)

          echo "Move commands: $move_count"
          echo "Rotate commands: $rotate_count"

          if [ $move_count -ne 3 ]; then
            echo "Error: Expected 3 move commands, found $move_count"
            exit 1
          fi

          if [ $rotate_count -ne 3 ]; then
            echo "Error: Expected 3 rotate commands, found $rotate_count"
            exit 1
          fi

          echo "✓ Flower CLI with MOVE+ROTATE test passed"

      - name: Validate generated code syntax
        run: |
          echo "Checking Python syntax..."
          python -m py_compile data/generated/*.py
          echo "✓ All generated code is syntactically valid"
