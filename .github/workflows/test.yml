name: Test Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint Python files
        run: |
          pip install flake8
          flake8 scripts/ --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: Generate test dataset
        run: |
          python scripts/generate_spline_dataset.py

      - name: Train models (mock/quick)
        run: |
          python scripts/train_sr_models.py

      - name: Generate code
        run: |
          python scripts/codegen_formulas.py

      - name: Run unit tests
        run: |
          python -m pytest tests/ -v --tb=short

      - name: Test CLI generation (Spline)
        run: |
          python scripts/generate_spline_cli.py --size 2.0 --opening 0.8 --layers 2 --output /tmp/test_rose.cli

          echo "Generated Spline CLI preview:"
          head -50 /tmp/test_rose.cli

          # Validate spline commands exist
          if ! grep -q "spline" /tmp/test_rose.cli; then
            echo "Error: No spline commands found"
            exit 1
          fi

          if ! grep -q "wing_flap" /tmp/test_rose.cli; then
            echo "Error: No wing_flap commands found"
            exit 1
          fi

          lines=$(wc -l < /tmp/test_rose.cli)
          echo "Total lines: $lines"

          if [ $lines -lt 50 ]; then
            echo "Error: Spline CLI seems too short"
            exit 1
          fi

          echo "✓ Spline CLI generation test passed"

      - name: Validate generated code syntax
        run: |
          echo "Checking Python syntax..."
          python -m py_compile data/generated/*.py
          echo "✓ All generated code is syntactically valid"
